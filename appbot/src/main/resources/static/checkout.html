<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>結帳</title>
    <title>Check Out</title>
    <!-- Load TapPay SDK -->
    <script src="https://js.tappaysdk.com/sdk/tpdirect/v5.14.0"></script>
    <script>
        // Initialize TapPay SDK
        const APP_ID = '12348';
        const APP_KEY = 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF';
        TPDirect.setupSDK(APP_ID, APP_KEY, 'sandbox');

        document.addEventListener('DOMContentLoaded', function () {
            // Setup card form UI
            const fields = {
                number: {
                    element: '#card-number',
                    placeholder: '**** **** **** ****'
                },
                expirationDate: {
                    element: '#card-expiration-date',
                    placeholder: 'MM / YY'
                },
                ccv: {
                    element: '#card-ccv',
                    placeholder: 'ccv'
                }
            };

            const styles = {
                'input': {
                    'color': 'gray'
                },
                ':focus': {
                    'color': 'black'
                },
                '.valid': {
                    'color': 'green'
                },
                '.invalid': {
                    'color': 'red'
                }
            };

            TPDirect.card.setup({
                fields: fields,
                styles: styles
            });
        });
        function onSubmit(){
            // get params from URL
            const url_params = new URLSearchParams(window.location.search);
            const line_user_id = url_params.get('line_user_id');
            const cart_id = url_params.get('cart_id');
            // get payment method
            const payment_method = document.querySelector('input[name=payment_method]:checked').value;
            TPDirect.card.getPrime(function(result){
                if (result.status !== 0){
                    alert('取得 prime 失敗 : ' + result.msg);
                    return;
                }
                // get prime
                const prime = result.card.prime;
                console.log("Prime : "+prime);
                // order data
                const order_data = {
                    prime: prime,
                    payment_method: payment_method,
                    line_user_id: line_user_id,
                    cart_id: cart_id,
                    receiver_name: receiver_name,
                    receiver_phone: receiver_phone,
                    receiver_address: receiver_address,
                    receiver_zipcode: receiver_zipcode,
                    receiver_email: receiver_email,
                };
                // send request to backend
                fetch('api/v1/order/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                })
                    .then(response=>{
                        if(!response.ok){
                            alert("驗證失敗，請輸入有效的信用卡資訊");
                            console.log("Prime 已取得但驗證有問題");
                        }else{
                            alert("付款成功！");
                            console.log("Payment post response: ", response.text());
                        }
                    })
                    .catch(error=>{
                        console.error("Error: ", error);
                        alert("提交訂單時發生錯誤！請稍後再試");
                    });
                });
            }
    </script>
    <style>
        .tpfield {
            height: 40px;
            width: 300px;
            border: 1px solid gray;
            margin: 5px 0;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div>
        <h3>付款資訊</h3>
        <div>
            <input type="radio" id="payment_method" name="payment_method" value="TapPay">
            <label for="payment_method">信用卡付款</label>
        </div>
        <div>
            <label for="card-number">Credit Card Number</label>
            <div class="tpfield" id="card-number"></div>
        </div>
        <div>
            <label for="card-expiration-date">Valid Thru</label>
            <div class="tpfield" id="card-expiration-date"></div>
        </div>
        <div>
            <label for="card-ccv">CCV</label>
            <div class="tpfield" id="card-ccv"></div>
        </div>
    </div>
<div>
    <h3>黑貓宅配資訊</h3>
    <div>
        <label for="recipient-name">收件人姓名</label>
        <input type="text" id="recipient-name" placeholder="請輸入收件人姓名" required />
    </div>
    <div>
        <label for="recipient-phone">收件人電話</label>
        <input type="text" id="recipient-phone" placeholder="請輸入收件人電話" required />
    </div>
    <div>
        <label for="recipient-address">收件人地址</label>
        <input type="text" id="recipient-address" placeholder="請輸入收件人地址" required />
    </div>
    <div>
        <label for="recipient-zipcode">收件人郵遞區號</label>
        <input type="text" id="recipient-zipcode" placeholder="請輸入郵遞區號" required />
    </div>
    <div>
        <label for="recipient-email">收件人電子郵件</label>
        <input type="email" id="recipient-email" placeholder="請輸入電子郵件" required />
    </div>
</div>
<button onclick="onSubmit()">結帳</button>
</body>
</html>